"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("three"),w=require("three/examples/jsm/utils/BufferGeometryUtils.js"),p=require("three.modifiers");function f(a){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const t in a)if(t!=="default"){const s=Object.getOwnPropertyDescriptor(a,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:()=>a[t]})}}return e.default=a,Object.freeze(e)}const o=f(m),h=f(p);class v extends p.UserDefined{constructor(e=p.ModConstant.Y,t=p.ModConstant.X,s=.5,i=.5,r=.5){super(),this.elevationAxis=e,this.alongAxis=t,this.effectRange=s,this.effectMid=i,this.elevationHeight=r,this.intensity=1,this.renderVector=this._renderVector}_renderVector(e,t,s){let i=e.getRatio(this.alongAxis),r=e.getValue(this.elevationAxis);if(i<=this.effectRange){i/=this.effectRange;let n=0;i<this.effectMid?(i=i/this.effectMid,n=Math.sqrt(1-Math.pow(i,2)+i*2-1)):(i=(i-this.effectMid)/(1-this.effectMid),n=(Math.cos(i*Math.PI)- -1)/2),e.setValue(this.elevationAxis,r+n*this.elevationHeight*this.intensity)}}}const u=a=>{for(var e=a.attributes.uv,t=0;t<e.count;t++){var s=e.getX(t),i=e.getY(t);e.setXY(t,1-s,i)}return a},g=new o.MeshStandardMaterial({color:"#ffffff"});class S extends o.Mesh{constructor(e=10){super();let t=new o.Mesh(w.mergeGeometries([u(new o.PlaneGeometry(1,1,e,e)),u(new o.PlaneGeometry(1,1,e,e).rotateY(Math.PI))],!0),[g,g]);t.castShadow=!0,t.receiveShadow=!0,t.rotateX(Math.PI/2),t.position.x=.5,this.scale.z=-1,this.add(t),this.page=t,this.modifiers=new h.ModifierStack(t),this.bend=new h.Bend(0,0,0),this.bend.constraint=h.ModConstant.LEFT,this.twist=new h.Twist(0),this.twist.vector=new h.Vector3(2,0,0),this.twist.center=new h.Vector3(-.5,0,0),this.pageCurve=new v(h.ModConstant.Z,h.ModConstant.X,.812,.325,.054),this.modifiers.addModifier(this.pageCurve),this.modifiers.addModifier(this.bend),this.modifiers.addModifier(this.twist)}setPageMaterial(e,t){this.page.material[t]=e}flip(e,t,s=1){this.rotation.z=Math.PI*e,this.bend.force=Math.min(-Math.sin(this.rotation.z)/2,-1e-4)*t,this.twist.angle=Math.sin(this.rotation.z)/10,this.pageCurve.intensity=(-1+2*e)*(-Math.sin(this.rotation.z)+1)*s,this.modifiers.apply()}disposeMaterial(e){const t=this.page.material[e];t!==g&&t.dispose()}reset(){this.setPageMaterial(g,0),this.setPageMaterial(g,1)}dispose(e=!1){e&&(this.disposeMaterial(0),this.disposeMaterial(1)),this.page.geometry.dispose(),this.modifiers.destroy()}}const d=function(){var a;return()=>{if(!a){const e=document.createElement("canvas");e.width=256,e.height=256;const t=e.getContext("2d"),s=t.createLinearGradient(0,0,e.width,0);s.addColorStop(0,"black"),s.addColorStop(.1,"white"),t.fillStyle=s,t.fillRect(0,0,e.width,e.height),a=new o.CanvasTexture(e),e.remove()}return a}}();class y extends o.Mesh{constructor(e){super(),this.pages=[],this.pool=[],this._url2Loader=new Map,this._currentProgress=0,this._flipDuration=(e==null?void 0:e.flipDuration)||1,this._ySpacing=(e==null?void 0:e.yBetweenPages)||.001,this._pageSubdivisions=(e==null?void 0:e.pageSubdivisions)||20,this.currentPage=0}[Symbol.iterator](){let e=0;return{next:()=>e<this.pages.length?{value:this.pages[e++],done:!1}:{value:null,done:!0}}}setPages(e){for(e.length%2!==0&&e.push("");this.pages.length;){let s=this.pages.pop();s.reset(),this.pool.push(s),this.remove(s)}let t=Promise.resolve();for(let s=0;s<e.length;s+=2){const i=e[s],r=e[s+1];let n=this.pool.pop();n||(n=new S(this._pageSubdivisions)),this.add(n),n.position.y=-this._ySpacing*this.pages.length,this.pages.push(n),n.name=`Page#${this.pages.length}`,t=t.then(this.loadPages(i,r,n))}this.currentPage>this.pages.length*2-1&&(this._currentPage=this.pages.length*2-1,this._currentProgress=this.pages.length),this.flipPages()}get totalPages(){return this.pages.length*2}loadPages(e,t,s){return()=>Promise.all([this.loadPage(e,1,s),this.loadPage(t,0,s)])}loadPage(e,t,s){if(!e||e===""){const r=new o.MeshStandardMaterial({color:"white",roughness:.2,aoMapIntensity:.7,aoMap:t==1?d():null});return s.setPageMaterial(r,t),Promise.resolve()}if(e instanceof o.Material)return s.setPageMaterial(e,t),Promise.resolve();if(e instanceof o.Texture)return s.setPageMaterial(this.textureToMaterial(e,t),t),Promise.resolve();const i=e;return this._url2Loader.has(i)||this._url2Loader.set(i,new Promise((r,n)=>{new o.TextureLoader().load(e,l=>{r(this.textureToMaterial(l,t))},void 0,l=>{r(null)})})),this._url2Loader.get(i).then(r=>{s.setPageMaterial(r,t)})}textureToMaterial(e,t){return e.magFilter=o.LinearFilter,e.minFilter=o.LinearFilter,e.generateMipmaps=!1,e.colorSpace=o.SRGBColorSpace,new o.MeshStandardMaterial({color:"white",map:e,roughness:.2,aoMapIntensity:.7,aoMap:t==1?d():null,toneMapped:!1})}get currentPage(){return this._currentPage}set currentPage(e){let t=Math.ceil(e/2),s=t-this._currentProgress;this._stepSize=s/this._flipDuration,this._flipDirection=this._stepSize>0?1:-1,this._currentPage=Math.ceil(e),this._goalProgress=t,this.flipPages()}get progress(){return this._currentProgress}set progress(e){let t=this._currentProgress;this._currentProgress=Math.max(0,Math.min(e,this.pages.length)),this._currentPage=Math.floor(this._currentProgress*2),this._stepSize=0,this._flipDirection=this._currentProgress>t?1:-1,this.flipPages()}animate(e){this._stepSize!=0&&(this._currentProgress+=this._stepSize*e,(this._stepSize>0&&this._currentProgress>this._goalProgress||this._stepSize<0&&this._currentProgress<this._goalProgress)&&(this._currentProgress=this._goalProgress,this._stepSize=0),this.flipPages())}flipPage(e){var t=this.pages.indexOf(e);if(t<0)throw new ReferenceError("I don't own that page! Not mine!");const s=t*2,i=s+1;this.currentPage=this._currentPage<=s?i:s}nextPage(){this.currentPage=Math.min(Math.ceil(this.currentPage/2)+1,this.pages.length)*2}previousPage(){this.currentPage=Math.max(Math.ceil(this.currentPage/2)-1,0)*2}flipPages(){const e=this.pages.length;let t=this._currentProgress%1,s=Math.floor(this._currentProgress);for(let r=0;r<e;r++){const n=this.pages[r],l=s<r?0:s>r?1:t,P=l<.5?0:(l-.5)/.5,M=-this._ySpacing*(e-r),c=-this._ySpacing*r,_=this._currentProgress<1?t:this._currentProgress>=e?0:this._currentProgress>=e-1?1-t:1;n.flip(l,this._flipDirection,_),n.position.y=c+P*(M-c)}const i=s==0?-.5+.5*t:s==e-1?.5*t:s==e?.5:0;this.position.x=i*this.scale.x}dispose(){for(;this.pages.length;){let e=this.pages.pop();this.remove(e)}for(;this.pool.length;)this.pool.pop().dispose(!0);this._url2Loader.forEach(e=>e.then(t=>t.dispose())),this._url2Loader.clear()}}exports.FlipBook=y;
